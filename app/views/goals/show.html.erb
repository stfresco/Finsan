<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="goal-show-container" style="background-color: #f5f5f5; padding: 20px; border-radius: 10px; max-width: 800px; margin: 20px auto; position: relative;">

  <div style="position: fixed; bottom: 20px; left: 20px;">
    <%= link_to "← Atrás", goals_path, class: "btn btn-back", style: "background-color: #f5f5f5; color: #00c897; padding: 10px 20px; border-radius: 5px; border: 2px solid #00c897; text-decoration: none; font-weight: bold;" %>
  </div>

  <h1 style="color: #00c897; font-weight: bold; text-align: center;"><%= @goal.title %></h1>

  <div class="goal-details-container" style="display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap;">

    <div class="goal-details" style="flex: 1; padding: 20px; background-color: white; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); border-radius: 10px;">
      <p><strong style="color: #00c897;">Descripción:</strong> <%= @goal.description %></p>
      <p><strong style="color: #00c897;">Monto:</strong> <%= @goal.amount || "Monto no definido" %></p>
      <p><strong style="color: #00c897;">Estado:</strong> <%= @goal.status == "in_progress" ? "Activo" : @goal.status %></p>
      <p><strong style="color: #00c897;">Fecha de Inicio:</strong> <%= @goal.start_date %></p>
      <p><strong style="color: #00c897;">Fecha de Término:</strong> <%= @goal.finish_date %></p>
    </div>


    <div class="goal-chart" style="flex: 1; padding: 20px; background-color: white; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <h4 style="color: #00c897;">Progreso</h4>
      <canvas id="goalProgressBarChart" width="400" height="200"></canvas>
    </div>
  </div>


  <div class="goal-transactions-chart" style="margin: 20px auto; max-width: 600px; padding: 20px; background-color: white; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); border-radius: 10px;">
    <h3 style="color: #00c897;">Transacciones Relacionadas</h3>
    <canvas id="transactionsDetailsChart" width="400" height="200"></canvas>
    <p style="margin-top: 20px; color: #00c897; text-align: center;"><strong>Total de Transacciones:</strong> <%= @goal.my_transactions.sum(:amount) %></p>
  </div>


  <div class="goal-actions" style="text-align: center; margin-top: 20px;">
    <%= link_to "Registrar una transacción", my_transaction_path(goal_id: @goal.id), class: "btn btn-add", style: "background-color: #00c897; color: white; font-weight: bold; padding: 10px 20px; border-radius: 5px; border: none; text-decoration: none; box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);" %>
    <%= link_to "Eliminar Meta", goal_path(@goal), method: :delete, data: { confirm: "¿Estás seguro de que deseas eliminar esta meta?" }, class: "btn btn-danger", style: "margin-left: 10px; background-color: #ff6b6b; border: none; padding: 10px 20px; color: white; border-radius: 5px; text-decoration: none;" %>
  </div>


  <div class="goal-tips" style="margin-top: 30px; text-align: center; color: #7a7a7a;">
    <p>¿Necesitas ayuda para alcanzar tus metas?</p>
    <p>Consulta nuestras guías y recursos para planificar tus objetivos.</p>
  </div>
</div>

<script>

  function renderTransactionsChart() {
    const transactionsCanvas = document.getElementById("transactionsDetailsChart");


    if (!transactionsCanvas) {
      console.error("Canvas para transacciones no encontrado.");
      return;
    }

    const transactionsCtx = transactionsCanvas.getContext("2d");

    const transactions = <%= @goal.my_transactions.map { |t| { amount: t.amount, date: t.date.strftime('%d/%m/%Y'), bank: t.account.bank } }.to_json.html_safe %>;


    if (transactions.length === 0) {
      console.warn("No hay datos de transacciones para mostrar en el gráfico.");
      return;
    }

    const transactionLabels = transactions.map(t => `${t.date} - ${t.bank}`);
    const transactionAmounts = transactions.map(t => t.amount);


    if (window.transactionsChart) {
      window.transactionsChart.destroy();
    }


    window.transactionsChart = new Chart(transactionsCtx, {
      type: "bar",
      data: {
        labels: transactionLabels,
        datasets: [{
          label: "Transacciones",
          data: transactionAmounts,
          backgroundColor: "rgba(0, 200, 151, 0.8)",
          borderColor: "rgba(0, 165, 125, 1)",
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: "top"
          },
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                const transaction = transactions[tooltipItem.dataIndex];
                return `Banco: ${transaction.bank}, Monto: ${transaction.amount}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }


  function renderProgressChart() {
    const progressCanvas = document.getElementById("goalProgressBarChart");


    if (!progressCanvas) {
      console.error("Canvas para progreso no encontrado.");
      return;
    }

    const progressCtx = progressCanvas.getContext("2d");

    const total = <%= @goal.amount || 0 %>;
    const saved = <%= @goal.my_transactions.sum(:amount) %>;
    const remaining = Math.max(total - saved, 0);

    new Chart(progressCtx, {
      type: "bar",
      data: {
        labels: ["Ahorrado", "Restante"],
        datasets: [{
          label: "Progreso del Objetivo",
          data: [saved, remaining],
          backgroundColor: ["#00c897", "#ff6b6b"],
          borderColor: ["#00a57d", "#d9534f"],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true,
            position: "top"
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  
  document.addEventListener("turbo:load", function () {
    renderProgressChart();
    renderTransactionsChart();
  });
</script>
